# SQL 19

관계명 데이터베이스를 제어하기 위한 언어이다.

## SQL 기본 및 활용 - SQL 기본

### 1. TCL

#### 1-1. TCL

- 논리적 작업 단위를 묶어 **DML에 의해 조작된 결과를 작업단위 별로 제어**
- commit, rollback 등이 여기에 해당
- 일부에서는 DCL로 분류함

#### 1-2. 트랜잭션

- 데이터베이스의 논리적인 연산 단위
- 트랜잭션은 밀접히 관련되어 분리될 수 없는 한 개 이상의 DB조작을 가리킴
- 트랜잭션은 하나 이상의 SQL 문장이 포함됨
- **분할할 수 없는 최소단위**이므로, 전부 적용하거나 전부 취소해야함

#### 1-3. 트랜잭션 특선 ACID

- **원자성**: 트랜잭션의 연산은 모두 적용되던지, 아니면 전혀 실행되지 않은 상태여야함
- **일관성**: 트랜잭션 실행 전 DB에 이상이 없다면, 실행 후에도 일관되게 이상이 없어야함
- **고립성**: 트랜잭션 실행 중, 다른 트랜잭션의 영향을 받아선 안됨
- **지속성**: 트랜잭션이 성공적으로 수행되면, 영구적으로 반영되어 저장됨

#### 1-4. DB 트랜잭션에 대한 격리성이 낮을 경우 발생하는 문제점

- Dirty Read: 다른 트랜잭션에 의해 수정되었지만, **아직 커밋되지 않은 Dirty한 데이터를 읽는 것**
- Non-Repeatable Read: **한 트랜잭션 내에서 같은 쿼리를 두 번 수행**했는데, 그 사이 다른 트랜잭션이 값을 수정, 삭제해서 **두 쿼리 결과가 다르게** 나타나는 현상
- Phantom Read: **한 트랜잭션 내에서 같은 쿼리를 두 번 수행**했는데, 첫 번째 쿼리에서 없던 **유령 레코드가 두 번째 쿼리에서 나타나는** 현상

#### 1-5. 트랜잭션을 컨트롤하는 TCL 

- Commit: 문제 없이 처리된 트랜잭션을 전부 DB에 반영
- RollBack: 트랜잭션 수행 이전 상태로 되돌림
- 트랜잭션 대상 SQL 
  - DML: Insert, Update, Delete
  - Select: Select For Update 등 배타적 LOCK을 요구하는 것들

#### 1-6. COMMIT

- 삽입, 수정, 삭제한 이력이 문제가 없을 경우, COMMIT 명령어로 **변경 사항 적용**
- COMMIT 이전 상태
  - 단지 Memory Buffer에만 영향을 주고, 이전 상태로 복구 가능
  - 현재 사용자는 Select문으로 변경 결과를 확인 가능
  - 다른 사용자는 현재 사용자가 수행한 결과를 **확인도 불가능**
  - 변경된 행은 아직 잠금 설정되어, **다른 사용자가 변경 불가능**
- COMMIT 이후 상태
  - 데이터에 대한 변경사항을 DB에 영구반영
  - 이전 데이터는 영원히 잃어버림
  - 모든 사용자가 결과 조회 가능
  - 변경된 행은 잠금이 해제되어, **다른 사용자가 변경, 확인 가능**

#### 1-7. Auto Commit

- `oracle`: DDL 문장 수행 후 자동으로 COMMIT 수행, **롤백해도 저장됨**
- `SQL Server`: DDL 문장 수행 후 자동으로 COMMIT 수행 안함

#### 1-8. RollBack

- 테이블에 삽입, 수정, 삭제한 데이터에 대해 COMMIT 이전에 변경사항을 취소
- RollBack 후 상태
  - 데이터에 대한 변경사항 취소됨
  - 이전 데이터가 다시 재저장됨
  - 관련 행에 대한 잠금이 풀리고, 다른 사용자들이 데이터 변경 가능

#### 1-9. BEGIN TRANSACTION

- 트랜잭션을 시작하는 구문 - COMMIT, ROLLBACK으로 종료
- **ROLLBACK을 만나면 최초의 BEGIN 시점까지 모두 ROLLBACK 수행됨**

```sql
Begin Transaction
Insert Into 품목(품목ID, 단가) Valuse (‘005’, 2000);
Commit 												--> 여기까지는 커밋됨
Begin Transaction 									--> 다시 시작 
Delete 품목 Where 품목ID = ‘002’;					 --> 취소
Begin Transaction 									--> 아직 종료 안됨 
Update 품목 Set 단가=2000 Where 단가=1000; 			--> 취소
ROLLBACK 											--> COMMIT되지 않은 트랜잭션 모두 취소
Select Count(품목ID) From 품목 Where 단가=2000;
													>>>결과 : 3
```

#### 1-10. Commit과 RollBack을 사용함으로써 얻을 수 있는 효과

- 데이터 무결성 보장
- 영구적인 변경을 하기 전에 데이터의 변경사항을 확인 가능
- 논리적으로 연관된 작업을 그룹핑하여 처리 가능

#### 1-11. SavePoint (저장점)

- savepoint를 지정하면 롤백할 경우, 전체 롤백이 아닌 **포인트까지의 일부만 롤백** 가능
- savepoint는 여러 개 지정 가능
- 동일 이름으로 지정 시, 가장 나중에 정의한 포인트가 유효함
- `orcle`

```sql
SavePoint 포인트 이름;
RollBack To 포인트 이름;
```

- `SQL Server`

```sql
Save Transaction 포인트 이름;
RollBack Transaction 포인트 이름;
```

#### 1-12. SavePoint 주의점

- 포인트1로 되돌리고 나서 그 이후 미래 포인트2로 되돌릴 수 없음
- 특정 포인트까지 롤백하면, 그 이후 포인트는 무효
- 포인트없이 롤백하면 모든 변경사항 취소됨